<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* --- 基础设置 (保持原版美化) --- */
    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
    
    body, html {
        width: 100%;
        height: auto; 
        min-height: 0; 
        background: transparent; 
        font-family: "Microsoft YaHei", sans-serif;
        color: #fff;
        overflow: hidden;
    }

    /* --- 播放器主体 --- */
    .st-music-widget {
        position: relative;
        width: 80%;             
        height: 880px;
        margin: 0 auto; 
        border-radius: 16px;
        overflow: hidden; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
    }

    /* 1. 背景层 */
    .widget-bg {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background-image: url('https://files.catbox.moe/ouqhj3.jpeg');
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover;
        z-index: 0;
        transition: background-image 0.5s ease;
    }

    /* 2. 磨砂滤镜层 */
    .widget-glass {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(135deg, rgba(255, 192, 203, 0.5), rgba(173, 216, 230, 0.5));
        backdrop-filter: blur(12px); 
        -webkit-backdrop-filter: blur(12px);
        z-index: 1;
    }

    /* 3. 内容层 */
    .widget-content {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 15px;
    }

    /* --- 上半部分：唱片 + 歌单 --- */
    .upper-section {
        flex: 1;
        display: flex;
        overflow: hidden; 
    }

    /* 左侧：唱片容器 */
    .disc-wrapper {
        flex: 0 0 135px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        padding-left: 25px; 
    }
    
    .disc {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #111;
        border: 3px solid rgba(255,255,255,0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        animation: rotate 15s linear infinite;
        animation-play-state: paused;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        margin: 0 auto; 
    }
    .disc.playing { animation-play-state: running; }
    
    .album-cover {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background-image: url('https://files.catbox.moe/ouqhj3.jpeg');
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover;
        transition: background-image 0.5s ease;
    }

    /* --- [修改处] 简约线条风格唱针 --- */
    .needle {
        position: absolute;
        /* 调整位置使其位于唱片右上方 (P3/P4样式) */
        top: 15px;
        left: 110px;
        /* 容器大小决定旋转中心和活动范围 */
        width: 20px;
        height: 80px;
        z-index: 5;
        /* 旋转中心设置在顶部圆点的中心位置 */
        transform-origin: 10px 6px;
        /* 停止状态：向外旋转 (P4/P6样式) */
        transform: rotate(25deg);
        transition: transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1); /* 使用更柔和的贝塞尔曲线 */
        pointer-events: none;
    }

    /* 播放状态：向内旋转到唱片上 (P3/P5样式) */
    .needle.playing { transform: rotate(-15deg); }

    /* 顶部圆点 (使用::before绘制) */
    .needle::before {
        content: ''; position: absolute;
        top: 0; left: 50%; transform: translateX(-50%);
        width: 12px; height: 12px;
        background: rgba(255,255,255,0.9); /* 稍微透明一点的白色 */
        border-radius: 50%;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* 极轻微的阴影增加立体感 */
    }

    /* 唱针杆直线 (使用::after绘制) */
    .needle::after {
        content: ''; position: absolute;
        top: 10px; /* 紧接圆点下方 */
        left: 50%; transform: translateX(-50%);
        width: 3px; /* 细线条 */
        height: 65px; /* 长度 */
        background: rgba(255,255,255,0.85);
        border-radius: 0 0 2px 2px; /* 底部圆角 */
    }
    /* --- [修改结束] --- */


    /* 右侧：歌单列表容器 */
    .playlist-wrapper {
        flex: 1;
        padding-left: 5px;
        overflow-y: auto; 
        padding-right: 18px; 
    }
    .playlist-wrapper::-webkit-scrollbar { width: 5px; }
    .playlist-wrapper::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

    .playlist-item {
        font-size: 13px;
        padding: 6px 4px 6px 8px;
        margin-bottom: 4px;
        border-radius: 6px;
        cursor: pointer;
        color: rgba(255,255,255,0.7);
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }
    .playlist-item:hover {
        background: rgba(255,255,255,0.1);
        color: #fff;
    }
    .playlist-item.active {
        background: rgba(255, 255, 255, 0.25);
        color: #fff;
        font-weight: bold;
        text-shadow: 0 0 5px rgba(255,255,255,0.5);
    }
    
    .song-left {
        display: flex; align-items: center; gap: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; 
        flex: 1; 
    }
    .delete-btn {
        width: 24px; height: 24px; 
        display: flex; justify-content: center; align-items: center;
        color: rgba(255,255,255,0.4);
        font-size: 16px;
        border-radius: 50%;
        margin-left: 15px; 
        transition: all 0.2s;
        flex-shrink: 0; 
    }
    .delete-btn:hover {
        background: rgba(255, 0, 0, 0.3);
        color: #fff;
    }

    .wave-icon {
        display: none;
        gap: 2px;
        height: 10px;
        align-items: flex-end;
    }
    .active .wave-icon { display: flex; }
    .wave-bar {
        width: 2px;
        background: #fff;
        animation: wave 0.8s infinite ease-in-out;
    }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 60%; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 30%; }

    /* --- 下半部分：控制条 --- */
    .controls-section {
        height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }

    .progress-area {
        display: flex;
        align-items: center;
        font-size: 10px;
        color: rgba(255,255,255,0.8);
        margin-bottom: 8px;
    }
    .progress-bar-bg {
        flex: 1;
        height: 4px;
        background: rgba(255,255,255,0.2);
        border-radius: 2px;
        margin: 0 10px;
        cursor: pointer;
        position: relative;
    }
    .progress-fill {
        width: 0%;
        height: 100%;
        background: #fff;
        border-radius: 2px;
        position: relative;
    }
    .progress-fill::after {
        content: ''; position: absolute; right: -4px; top: -3px;
        width: 10px; height: 10px; background: #fff; border-radius: 50%;
        opacity: 0; transition: opacity 0.2s;
    }
    .progress-bar-bg:hover .progress-fill::after { opacity: 1; }

    .btn-row {
        display: flex;
        justify-content: space-between; 
        align-items: center;
        padding: 0 5px;
    }
    .main-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        position: absolute; 
        left: 50%;
        transform: translateX(-50%);
    }

    /* [新增] 左侧控制区样式 */
    .left-controls { display: flex; gap: 5px; align-items: center; }
    
    /* 右侧控制区样式 */
    .right-controls { display: flex; gap: 5px; align-items: center; }

    .side-btn {
        background: none; border: none; color: #fff; opacity: 0.6; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        width: 30px; height: 30px;
    }
    .side-btn:hover { opacity: 1; transform: scale(1.1); transition: all 0.2s; }
    
    .play-btn {
        width: 36px; height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: #fff;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer;
        transition: transform 0.1s;
    }
    .play-btn:active { transform: scale(0.95); }
    .play-btn svg { width: 18px; height: 18px; fill: currentColor; }
    .ctrl-icon { width: 22px; height: 22px; fill: currentColor; }
    .sm-icon { width: 16px; height: 16px; fill: currentColor; }

    /* 音量控制 */
    .volume-wrapper {
        position: relative;
        display: flex; align-items: center;
    }
    .volume-popup {
        position: absolute;
        bottom: 35px; left: 50%; transform: translateX(-50%);
        width: 32px; height: 100px;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
        border-radius: 16px;
        display: flex; justify-content: center; align-items: center;
        padding: 10px 0;
        opacity: 0; pointer-events: none;
        transition: opacity 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .volume-popup.show { opacity: 1; pointer-events: auto; }
    .vol-range {
        -webkit-appearance: none; width: 80px; height: 4px;
        background: rgba(255,255,255,0.3); border-radius: 2px;
        outline: none; transform: rotate(-90deg); cursor: pointer;
    }
    .vol-range::-webkit-slider-thumb {
        -webkit-appearance: none; width: 12px; height: 12px;
        background: #fff; border-radius: 50%; cursor: pointer;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes wave { 0%, 100% { height: 30%; } 50% { height: 100%; } }

    /* --- 内部小弹窗 (用于输入关键词/添加URL) --- */
    .modal-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10;
        display: flex; justify-content: center; align-items: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
        backdrop-filter: blur(5px);
    }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    
    .modal-box {
        background: #fff; padding: 15px; border-radius: 10px; width: 80%;
        text-align: center; color: #333;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        display: flex; flex-direction: column;
    }
    .modal-box h4 { margin-bottom: 10px; font-size: 16px; }
    .modal-box input { width: 100%; margin: 5px 0 15px 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    
    .modal-btns { display: flex; justify-content: space-around; margin-top: 10px; }
    .modal-btns button { 
        padding: 5px 20px; cursor: pointer; border: none; border-radius: 5px; 
        font-weight: bold; transition: background 0.2s;
    }
    .btn-confirm { background: #ffc0cb; color: #fff; }
    .btn-cancel { background: #eee; color: #666; }
    .btn-search { background: #87ceeb; color: #fff; width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 5px; border:none; cursor: pointer; }

    /* --- 全屏独立搜索结果界面 --- */
    #fullscreen-result-layer {
        position: fixed; /* 突破播放器大小限制 */
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.85);
        z-index: 9999;
        display: flex; justify-content: center; align-items: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
        backdrop-filter: blur(8px);
    }
    #fullscreen-result-layer.show { opacity: 1; pointer-events: auto; }

    .result-container {
        width: 90%; max-width: 500px;
        height: 80%;
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        display: flex; flex-direction: column;
        color: #333;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .result-header {
        display: flex; justify-content: space-between; align-items: center;
        padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 5px;
    }
    .result-header h4 { font-size: 16px; margin: 0; font-weight: bold; }
    .btn-close-res { font-size: 13px; padding: 5px 12px; background: #ffc0cb; color: #fff; border: none; border-radius: 4px; cursor: pointer; }

    /* 结果列表容器 */
    #search-results-full {
        flex: 1;
        overflow-y: auto;
        padding-right: 5px;
    }
    
    .search-item {
        padding: 12px 8px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        font-size: 14px;
        display: flex; justify-content: space-between; align-items: center;
        transition: background 0.2s;
    }
    .search-item:last-child { border-bottom: none; }
    .search-item:hover { background: #f0f8ff; }
    
    .item-info { display: flex; flex-direction: column; max-width: 75%; }
    .item-title { font-weight: bold; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .item-singer { font-size: 12px; color: #888; margin-top: 4px; }
    
    .source-tag {
        font-size: 11px; padding: 3px 8px; border-radius: 4px;
        color: #fff; min-width: 50px; text-align: center;
    }
    .tag-qq { background: #2ecc71; }
    .tag-wy { background: #e74c3c; }

    .loading-container {
        display: flex; flex-direction: column;
        justify-content: center; align-items: center; 
        height: 100%; color: #999; font-size: 14px; gap: 10px;
    }

    .hidden { display: none; }
</style>
</head>
<body>

<div class="st-music-widget">
    <div class="widget-bg" id="widget-bg"></div>
    <div class="widget-glass"></div>
    
    <div class="widget-content">
        
        <div class="upper-section">
            <div class="disc-wrapper">
                <div class="needle" id="needle"></div>
                <div class="disc" id="disc">
                    <div class="album-cover" id="album-cover"></div>
                </div>
            </div>
            
            <div class="playlist-wrapper" id="playlist-container">
                </div>
        </div>

        <div class="controls-section">
            <div style="font-size: 12px; margin-bottom: 5px; padding-left: 5px; opacity: 0.9;">
                <span id="current-title" style="font-weight: bold;">Loading...</span>
            </div>

            <div class="progress-area">
                <span id="curr-time">0:00</span>
                <div class="progress-bar-bg" id="prog-bg">
                    <div class="progress-fill" id="prog-fill"></div>
                </div>
                <span id="total-time">0:00</span>
            </div>

            <div class="btn-row">
                <div class="left-controls">
                    <button class="side-btn" id="mode-btn" title="循环模式">
                        <svg class="sm-icon" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                    </button>

                    <div class="volume-wrapper">
                        <div class="volume-popup" id="vol-popup">
                            <input type="range" min="0" max="1" step="0.05" value="0.8" class="vol-range" id="vol-range">
                        </div>
                        <button class="side-btn" id="vol-btn" title="调节音量">
                            <svg class="sm-icon" viewBox="0 0 24 24">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="main-controls">
                    <button class="side-btn" id="prev-btn">
                        <svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>
                    
                    <button class="play-btn" id="play-btn">
                        <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="icon-pause" class="hidden" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    
                    <button class="side-btn" id="next-btn">
                        <svg class="ctrl-icon" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                </div>

                <div class="right-controls">
                    <button class="side-btn" id="search-btn" title="搜索歌曲">
                        <svg class="sm-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    </button>

                    <button class="side-btn" id="bg-btn" title="更换背景">
                        <svg class="sm-icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    </button>
                    <button class="side-btn" id="add-btn" title="手动添加">
                        <svg class="sm-icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="search-input-modal">
        <div class="modal-box">
            <h4>搜索歌曲</h4>
            <input type="text" id="search-keyword" placeholder="输入歌名 或 歌手">
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal('search-input-modal')">取消</button>
                <button class="btn-search" style="margin:0; width:auto;" onclick="startSearch()">开始搜索</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="add-modal">
        <div class="modal-box">
            <h4>手动添加直链</h4>
            <input type="text" id="new-title" placeholder="歌名">
            <input type="text" id="new-url" placeholder="直链URL (mp3)">
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal('add-modal')">取消</button>
                <button class="btn-confirm" onclick="confirmAdd()">确定</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="bg-modal">
        <div class="modal-box">
            <h4>更换背景图片</h4>
            <input type="text" id="new-bg-url" placeholder="图片链接 (jpg/png)">
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal('bg-modal')">取消</button>
                <button class="btn-confirm" onclick="confirmBg()">确定</button>
            </div>
        </div>
    </div>

</div>

<div id="fullscreen-result-layer">
    <div class="result-container">
        <div class="result-header">
            <h4>搜索结果</h4>
            <div style="display:flex; gap:10px;">
                <button class="btn-close-res" style="background:#eee; color:#666;" onclick="backToSearch()">← 重搜</button>
                <button class="btn-close-res" onclick="closeModal('fullscreen-result-layer')">关闭</button>
            </div>
        </div>
        <div id="search-results-full"></div>
    </div>
</div>

<script>
    // --- 多开互斥逻辑 (BroadcastChannel) ---
    const channel = new BroadcastChannel('st_music_widget_global');
    const myWidgetId = Date.now().toString() + Math.random().toString();

    channel.onmessage = (event) => {
        const data = event.data;
        if (data.action === 'play' && data.id !== myWidgetId) {
            if (isPlaying) {
                console.log('收到其他播放器指令，暂停当前播放');
                audio.pause();
                isPlaying = false;
                updateState();
            }
        }
    };

    // --- 播放器基础数据 ---
    let playlist = [
        { title: '精卫', url: 'https://files.catbox.moe/q4nbyr.mp3' },
        { title: '是风动', url: 'https://files.catbox.moe/z2iupn.mp3' },
        { title: '我用什么把你留住', url: 'https://files.catbox.moe/xknwt1.mp3' },
    ];

    let currentIdx = 0;
    let isPlaying = false;
    let playMode = 0; 
    const audio = new Audio();
    audio.crossOrigin = "anonymous";
    audio.volume = 0.8;

    // DOM Elements
    const disc = document.getElementById('disc');
    const needle = document.getElementById('needle');
    const playBtn = document.getElementById('play-btn');
    const iconPlay = document.getElementById('icon-play');
    const iconPause = document.getElementById('icon-pause');
    const progFill = document.getElementById('prog-fill');
    const progBg = document.getElementById('prog-bg');
    const currTimeEl = document.getElementById('curr-time');
    const totalTimeEl = document.getElementById('total-time');
    const titleEl = document.getElementById('current-title');
    const listContainer = document.getElementById('playlist-container');
    const widgetBg = document.getElementById('widget-bg');
    const albumCover = document.getElementById('album-cover');
    const volBtn = document.getElementById('vol-btn');
    const volPopup = document.getElementById('vol-popup');
    const volRange = document.getElementById('vol-range');
    
    // Search DOMs
    const resultListFull = document.getElementById('search-results-full');

    // Init
    renderPlaylist();
    loadTrack(0, false);

    // --- Playlist Logic ---
    function renderPlaylist() {
        listContainer.innerHTML = '';
        playlist.forEach((song, idx) => {
            const item = document.createElement('div');
            item.className = `playlist-item ${idx === currentIdx ? 'active' : ''}`;
            item.onclick = (e) => {
                loadTrack(idx, true);
            };

            const leftPart = document.createElement('div');
            leftPart.className = 'song-left';
            leftPart.innerHTML = `
                <span>${idx + 1}. ${song.title}</span>
                <div class="wave-icon">
                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                </div>
            `;
            
            const delBtn = document.createElement('div');
            delBtn.className = 'delete-btn';
            delBtn.innerHTML = '×';
            delBtn.title = "删除歌曲";
            delBtn.onclick = (e) => {
                e.stopPropagation();
                deleteTrack(idx);
            };

            item.appendChild(leftPart);
            item.appendChild(delBtn);
            listContainer.appendChild(item);
        });
    }

    function deleteTrack(idx) {
        if (playlist.length <= 1) {
            alert("至少保留一首歌曲哦");
            return;
        }
        if (idx === currentIdx) {
            audio.pause();
            isPlaying = false;
            updateState();
            playlist.splice(idx, 1);
            if (currentIdx >= playlist.length) currentIdx = 0;
            loadTrack(currentIdx, false);
        } else {
            playlist.splice(idx, 1);
            if (idx < currentIdx) currentIdx--; 
            renderPlaylist();
        }
    }

    function loadTrack(idx, autoPlay = false) {
        if(idx < 0 || idx >= playlist.length) return;
        currentIdx = idx;
        audio.src = playlist[idx].url;
        titleEl.textContent = playlist[idx].title;
        renderPlaylist();
        
        if(playlist[idx].cover) {
            widgetBg.style.backgroundImage = `url('${playlist[idx].cover}')`;
            albumCover.style.backgroundImage = `url('${playlist[idx].cover}')`;
        }

        if (autoPlay) {
            playAudioSafe();
        } else {
            isPlaying = false;
            updateState();
        }
    }

    function playAudioSafe() {
        channel.postMessage({ action: 'play', id: myWidgetId });
        audio.play().then(() => {
            isPlaying = true;
            updateState();
        }).catch(e => console.error(e));
    }

    function updateState() {
        if (isPlaying) {
            iconPlay.classList.add('hidden');
            iconPause.classList.remove('hidden');
            disc.classList.add('playing');
            needle.classList.add('playing');
        } else {
            iconPlay.classList.remove('hidden');
            iconPause.classList.add('hidden');
            disc.classList.remove('playing');
            needle.classList.remove('playing');
        }
    }

    playBtn.onclick = () => {
        if (audio.paused) {
            playAudioSafe();
        } else {
            audio.pause();
            isPlaying = false;
            updateState();
        }
    };

    document.getElementById('next-btn').onclick = nextTrack;
    document.getElementById('prev-btn').onclick = prevTrack;

    function nextTrack() {
        let next = currentIdx + 1;
        if (playMode === 2) next = Math.floor(Math.random() * playlist.length);
        if (next >= playlist.length) next = 0;
        loadTrack(next, true);
    }

    function prevTrack() {
        let prev = currentIdx - 1;
        if (prev < 0) prev = playlist.length - 1;
        loadTrack(prev, true);
    }

    audio.ontimeupdate = () => {
        if (isNaN(audio.duration)) return;
        const pct = (audio.currentTime / audio.duration) * 100;
        progFill.style.width = pct + '%';
        currTimeEl.textContent = fmtTime(audio.currentTime);
        totalTimeEl.textContent = fmtTime(audio.duration);
    };

    audio.onended = () => {
        if (playMode === 1) {
            audio.currentTime = 0;
            playAudioSafe();
        } else {
            nextTrack();
        }
    };

    progBg.onclick = (e) => {
        const rect = progBg.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        audio.currentTime = pos * audio.duration;
    };

    // --- Volume Control ---
    volBtn.onclick = (e) => {
        e.stopPropagation();
        volPopup.classList.toggle('show');
    };
    volRange.oninput = () => { audio.volume = volRange.value; };
    document.onclick = (e) => {
        if (!volBtn.contains(e.target) && !volPopup.contains(e.target)) {
            volPopup.classList.remove('show');
        }
    };

    // --- Search Logic (Split Windows) ---
    
    // 1. 点击放大镜，打开输入弹窗
    document.getElementById('search-btn').onclick = () => {
        document.getElementById('search-input-modal').classList.add('show');
        document.getElementById('search-keyword').focus();
    };

    // 2. 开始搜索：打开全屏结果层
    async function startSearch() {
        const kw = document.getElementById('search-keyword').value.trim();
        if (!kw) return;
        
        closeModal('search-input-modal');
        document.getElementById('fullscreen-result-layer').classList.add('show');
        
        resultListFull.innerHTML = '<div class="loading-container"><span>正在从云端检索...</span></div>';
        
        try {
            const [qqRes, wyRes] = await Promise.allSettled([
                fetch(`https://api.vkeys.cn/v2/music/tencent?word=${kw}`).then(r => r.json()),
                fetch(`https://api.vkeys.cn/v2/music/netease?word=${kw}`).then(r => r.json())
            ]);

            let results = [];

            if (qqRes.status === 'fulfilled' && qqRes.value.data) {
                qqRes.value.data.forEach(item => {
                    if(!item.song.match(/live/gi)) { 
                        results.push({
                            id: item.id,
                            song: item.song,
                            singer: item.singer,
                            cover: item.cover,
                            source: 'qq',
                            sourceName: 'QQ音乐'
                        });
                    }
                });
            }

            if (wyRes.status === 'fulfilled' && wyRes.value.data) {
                wyRes.value.data.forEach(item => {
                    results.push({
                        id: item.id,
                        song: item.song,
                        singer: item.singer,
                        cover: item.cover,
                        source: 'netease',
                        sourceName: '网易云'
                    });
                });
            }

            renderSearchResults(results);

        } catch (e) {
            console.error(e);
            resultListFull.innerHTML = '<div class="loading-container" style="color:red;">搜索服务暂时不可用，请稍后重试</div>';
        }
    }

    window.backToSearch = () => {
        closeModal('fullscreen-result-layer');
        document.getElementById('search-input-modal').classList.add('show');
    };

    function renderSearchResults(list) {
        if(list.length === 0) {
            resultListFull.innerHTML = '<div class="loading-container">未找到相关歌曲</div>';
            return;
        }

        resultListFull.innerHTML = '';
        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'search-item';
            const tagClass = item.source === 'qq' ? 'tag-qq' : 'tag-wy';
            
            div.innerHTML = `
                <div class="item-info">
                    <span class="item-title">${item.song}</span>
                    <span class="item-singer">${item.singer}</span>
                </div>
                <span class="source-tag ${tagClass}">${item.sourceName}</span>
            `;

            div.onclick = async () => {
                const originalContent = div.innerHTML;
                div.style.background = '#e6e6e6';
                div.innerHTML = `<div style="width:100%; text-align:center; color:#666; font-size:12px;">正在解析真实地址...</div>`;
                
                const playUrl = await fetchMusicUrl(item.source, item.id);
                
                if(playUrl) {
                    playlist.push({
                        title: item.song,
                        url: playUrl,
                        cover: item.cover
                    });
                    closeModal('fullscreen-result-layer'); 
                    loadTrack(playlist.length - 1, true); 
                    listContainer.scrollTop = listContainer.scrollHeight; 
                } else {
                    div.innerHTML = `<div style="width:100%; text-align:center; color:red; font-size:12px;">解析失败 (VIP或版权限制)</div>`;
                    setTimeout(() => {
                        div.style.background = '';
                        div.innerHTML = originalContent;
                    }, 2000);
                }
            };
            
            resultListFull.appendChild(div);
        });
    }

    async function fetchMusicUrl(source, id) {
        try {
            const apiUrl = `https://api.vkeys.cn/v2/music/${source}?id=${id}`;
            const res = await fetch(apiUrl).then(r => r.json());
            
            if(res && res.data && res.data.url) {
                const url = res.data.url;
                const isOk = await checkAudioAvailability(url);
                return isOk ? url : null;
            }
            return null;
        } catch(e) {
            console.error(e);
            return null;
        }
    }

    async function checkAudioAvailability(url) {
        return new Promise((resolve) => {
            const tester = new Audio();
            let timer;
            const onLoaded = () => { cleanup(); resolve(true); };
            const onError = () => { cleanup(); resolve(false); };
            const cleanup = () => {
                tester.removeEventListener('loadedmetadata', onLoaded);
                tester.removeEventListener('error', onError);
                clearTimeout(timer);
                tester.src = '';
            };
            tester.preload = 'metadata';
            tester.src = url;
            timer = setTimeout(onError, 3000); 
            tester.addEventListener('loadedmetadata', onLoaded);
            tester.addEventListener('error', onError);
        });
    }

    // --- Mode Toggle ---
    const modeBtn = document.getElementById('mode-btn');
    const modeIcons = [
        '<path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/>', 
        '<path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z"/>', 
        '<path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>' 
    ];
    modeBtn.onclick = () => {
        playMode = (playMode + 1) % 3;
        modeBtn.querySelector('svg').innerHTML = modeIcons[playMode];
    };

    function fmtTime(s) {
        const m = Math.floor(s / 60);
        const sc = Math.floor(s % 60);
        return `${m}:${sc<10?'0'+sc:sc}`;
    }

    // --- Modals Logic ---
    window.closeModal = (id) => document.getElementById(id).classList.remove('show');

    document.getElementById('add-btn').onclick = () => document.getElementById('add-modal').classList.add('show');
    window.confirmAdd = () => {
        const t = document.getElementById('new-title').value;
        const u = document.getElementById('new-url').value;
        if(t && u) {
            playlist.push({ title: t, url: u });
            renderPlaylist();
            closeModal('add-modal');
        }
    };

    document.getElementById('bg-btn').onclick = () => document.getElementById('bg-modal').classList.add('show');
    window.confirmBg = () => {
        const url = document.getElementById('new-bg-url').value.trim();
        if(url) {
            widgetBg.style.backgroundImage = `url('${url}')`;
            albumCover.style.backgroundImage = `url('${url}')`;
            closeModal('bg-modal');
        }
    };
</script>
</body>
</html>
